### SSH安全措施

```
服务器安全第一条:启用尽可能少的服务.
服务器安全第二条:管好你的ssh.
```
      
1) 禁止root用户远程登录

root是linux里的最高统帅了,就它官最大,可以在系统里畅通无阻.也就是因为这个原因,它是我们的重点保护对象.对于管理linux系统,一个最基本的建议就是:平时登陆和工作的时候都使用普通用户进行操作.在需要修改系统设置使用特级权限时,再切换到root用户（su  - root）.这样可以最大限度的避免因为误操作造成对linux系统的破坏.另外因为root用户是每个linux系统里都内置的,恶意的黑客可能会拿它做用户名然后尝试用不同的密码登陆密码哟.所以还是自己新建一个帐号,这样用户名被猜中的机率就很低了,再禁止root用户登陆,想猜密码?先猜用户吧.

在sshd_config中修改如下就可以了:

```
PermitRootLogin  no
```
     
2) 禁止空密码登陆

再有就是空密码.一般来说linux系统都会内置很多帐号,而这些用户的密码我们是不知道的.谁知道哪天哪个linux的发行版,对其中的帐号设置空密码或者指定的密码呢?所以还是禁止为妙,省得夜长梦多.
在sshd_config这样修改:

```
PermitEmptyPasswords  no
```

3) 使用非默认端口，非22端口

其实吧很多时候你的服务器被盯上,并不是有人特别跟你过不去.人家随机的用软件扫了一个ip段,而你的ip正好在里面.而人家的扫描规则就是:是否开启22端口.这个时候,如果你没有禁止root登陆,root的密码又是简单的123456或者000000,111111这些地球人都知道的密码的话,你的服务器不黑,谁的被黑?所以安全从简单的小事儿做起,你向前移动一小步,你的服务器安全就进步一大步.还等什么?先修改默认端口呗,打开sshd_config文件,修改成:

```
Port 30003
```

  根据你的心情,port随机的选一个,除了你自己,鬼知道你当时选的哪个端口.再打开/var/log/secure,看下世界是不是一下子清静了?再也没有烦人的用不同的帐号和密码尝试登陆的日志了.这招百试不爽.

4) 限制ssh监听的ip

  在服务器有多个ip的时候.设置ssh服务器只监听在指定的ip,未尝不是一个好办法.例如一组服务器中,肯定会组成内网和外网两个小的局域网.这时候只让不起眼的一两台机器的ssh服务监听到公网ip上.其它的机器ssh只监听内网ip,通过另外的一两台机器登陆进行管理,是不是很安全保守的做法呢?

在sshd_config中修改如下:

```
ListenAddress 192.168.1.5
```

如上的写法,是ssh服务器只监听192.168.1.5这个ip.

5) 使用的协议版本2： ssh v2

ssh协议有两个版本.肯定v2要比v1安全高效的多了.ssh服务器默认会接受两种协议的连接.为了保证服务器的安全,咱们可以定义服务器只使用v2:
在sshd_config中修改如下:

```
Protocol 2
```

6) 禁用密码登陆，推荐使用密钥登录，并且私钥使用强密码加密

其实经过前面几步简单的设置,个人认为ssh服务器的安全已经有了一个质的提高.但是在不使用其它复杂的手段的情况下,还有一些加固的小技巧,例如这一条:禁止使用密码登陆.什么?是不是写错了,或者弄迷糊了?ssh服务器竟然要禁止使用密码登陆?那怎么管理服务器呢?当然还是用ssh啦.ssh服务器不单支持密码认证,还支持通过key的认证方式,而且是默认的哟.关于怎样生成key的方法参见:<<使ssh不用输入密码>>

在sshd_config中修改如下:

```
PasswordAuthentication no
```

经过这点小的改动,你的ssh服务绝对又是一个质的提升.能够拿到你的私key,又知道服务器登陆的用户名和端口,这绝对不是一件简单的事儿吧.

7) 限制连接IP，仅保证有限的机器能够远程访问

现在再拿出最后一招杀手锏:限制ssh服务连接的ip.我们前面提到一组服务器我们只留一两台机器可以远程访问.这样这两台机器的安全又成了重中之重.怎样再保证一下这两台机器的安全呢?我们可以限制连接这两台机器的ip.例如:这两台机器只允许公司的出口ip进行访问.这样就再次提高了服务器的安全系数.想想如果有一个黑客,能够进入你们公司的办公网络,能够拿到你的私key,又能知道只有你才知道的服务器的用户名和登陆的端口,以及登陆的方式,如果有这样的牛X的黑客,还有什么好防的呢?因为防不胜防啊.扯远了,看下限制ip的做法:

在/etc/hosts.allow输入

```
sshd:192.168.1.5:allow
#(其中192.168.1.5是你要允许登陆ssh的ip,或者是一个网段192.168.1.0/24)
```
在/etc/hosts.deny输入

```
sshd:ALL
#(表示除了hosts.allow中允许的，其他的ip拒绝登陆ssh)
```

呵呵,这是传统的做法,因为开了防火墙所以笔者更喜欢直接在防火墙上做设置:)

使用 iptables 设置 ssh 服务安全访问策略。

8) 日志

记录好日志，经常做日志分析。

用户登录成功日志： /var/log/wtmp  , 使用 # last 命令查看

用户登录失败日志： /var/log/btmp , 使用 # lastb 命令查看

查看所有用户上次登录情况： 使用  #lastlog [-u User]

关于ssh安全的其它做法:

令牌: 笔者的哥们所在的游戏公司,专门为了服务器的登陆开发了一个程序.所有的服务器统一认证.密码放在数据库里,当你想登陆的时候,先访问一个网页,验证完信息以后会给你的手机发一条短信告诉你登陆的密码.而且会告诉你一分钟内有效,过时重取,哈哈,除了数据库自己,谁也不知道密码是多少,是不是很专业呢?

动态ssh: 据说有这么一种做法,在服务器上安装另外一个程序,当然也是开源的.那个程序会打开一个你指定的端口,而默认的时候ssh服务是关闭的.当你需要登陆服务器的时候.你先telnet一下,你的ip和你指定的先前那个程序所监听的端口,那个程序就会帮你把ssh服务打开,然后你就可以进行正常的登陆操作了.是不是也很专业呢?

ssh 最佳实践：

```
Port 30003
ListenAddress 192.168.1.5
Protocol 2
 
#白名单
AllowUsers user1 user2
#黑名单
denyUser user3 user4
 
PasswordAuthentication no
PermitEmptyPasswords no
PermitRootLogin  no
UseDNS no
```
